## Добавление контактного лица на форму контрагента

Модуль формы
```
&НаКлиенте
Процедура КонтрагентПриИзменении(Элемент)
  
  КонтрагентПередИзменением = Контрагент;
  Контрагент = Объект.Контрагент;
  ПустойКонтрагентПередИзменением = КонтрагентПередИзменением.Пустая();
  
  Если КонтрагентПередИзменением <> Объект.Контрагент Тогда
    
    ДанныеКонтрагента = ПрочитатьДанныеКонтрагента(Объект.Дата, Объект.ВалютаДокумента, Объект.Контрагент, Объект.Организация);
    ДанныеКонтрагента.Вставить("ВызовИзПроцедурыПриИзмененииКонтрагента", Истина);
    ДанныеКонтрагента.Вставить("ПустойКонтрагентПередИзменением", ПустойКонтрагентПередИзменением);
    Объект.Договор = ДанныеКонтрагента.Договор;
    ОбработатьИзменениеДоговора(ДанныеКонтрагента);
    УправлениеФормой();
    
    ЗаполнитьПоляДоставки(Объект, ДанныеКонтрагента);
    
    ЗаполнитьСписокВыбораПолучателя(Элементы.КонтактноеЛицо, ДанныеКонтрагента.ДанныеКонтактныхЛиц);
    ЗаполнитьСписокВыбораАдресаДоставки(Элементы.АдресДоставкиПолучателя, ДанныеКонтрагента.АдресаДоставки);   
    
    Объект.КонтактЛицо = КонтактноеЛицо(Объект.Контрагент);
    
  Иначе
    
    Объект.Договор = Договор; // Восстанавливаем автоматически очищеный договор.
    
  КонецЕсли;
  
  // АвтоматическиеСкидки
  СброситьФлагСкидкиРассчитаныКлиент("КонтрагентПриИзменении");
  
  ОчиститьКалькуляцию();
  ВключитьИндикаторНеобходимостиПересчетаСтоимостиДоставки();
  
  СтатистикаИспользованияФормКлиент.ПриИнтерактивномДействии(ЭтотОбъект, Элемент, "ПриИзменении");
  
КонецПроцедуры  

// Добавленная функция для получения контактов
&НаСервере
Функция КонтактноеЛицо(Контрагент) 
  Запрос = Новый Запрос();
  ТекстЗапроса = 
  "ВЫБРАТЬ
  | СвязиКонтрагентКонтактСрезПоследних.Контакт.Ссылка КАК КонтактСсылка
  |ИЗ
  | РегистрСведений.СвязиКонтрагентКонтакт.СрезПоследних КАК СвязиКонтрагентКонтактСрезПоследних
  |ГДЕ
  | СвязиКонтрагентКонтактСрезПоследних.СвязьНедействительна = ЛОЖЬ
  | И СвязиКонтрагентКонтактСрезПоследних.Контрагент = &Контрагент
  | И СвязиКонтрагентКонтактСрезПоследних.Период <= &Дата";

  Запрос.Текст = ТекстЗапроса;  
  Запрос.УстановитьПараметр("Контрагент", Контрагент);
  Запрос.УстановитьПараметр("Дата", ДатаДокумента);

  Результат = Запрос.Выполнить();
  Выборка = Результат.Выбрать(); 
  
  Если Выборка.Количество() = 1 Тогда
    Выборка.Следующий();
    Возврат Выборка.КонтактСсылка;  
  Иначе       
    Возврат Справочники.КонтактныеЛица.ПустаяСсылка();
  КонецЕсли; 
  
КонецФункции 


&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
  
  Если НЕ Отказ Тогда
    Если Объект.ВидОперации<>ПредопределенноеЗначение("Перечисление.ВидыОперацийЗаказПокупателя.ЗаказНаПереработку") Тогда
      Объект.МатериалыЗаказчика.Очистить();
    КонецЕсли; 
  КонецЕсли; 
  
  // АвтоматическиеСкидки
  СкидкиРассчитаныПередЗаписью = Ложь;
  // Если документ проводится, проверим рассчитанность скидок.
  Если ИспользоватьАвтоматическиеСкидки Тогда
    
    Если Не Объект.СкидкиРассчитаны И СкидкиИзменились() Тогда
      РассчитатьСкидкиНаценкиКлиент();
      РассчиталиСкидки = Истина;
      
      Сообщение = Новый СообщениеПользователю;
      Сообщение.Текст = "Рассчитаны автоматические скидки (наценки)!";
      Сообщение.КлючДанных = Объект.Ссылка;
      Сообщение.Сообщить();
      
      СкидкиРассчитаныПередЗаписью = Истина;
      
      ОбновитьИтогиКлиент();
    Иначе
      Объект.СкидкиРассчитаны = Истина;
      ОбновитьКартинкуАвтоСкидкиПослеЗаписи = Истина;
    КонецЕсли;
    
  КонецЕсли;
  // Конец АвтоматическиеСкидки
  
  // СтандартныеПодсистемы.ОценкаПроизводительности
  Если ПараметрыЗаписи.РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
    ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина, "Проведение"+ РаботаСФормойДокументаКлиентСервер.ПолучитьИмяФормыСтрокой(ЭтотОбъект.ИмяФормы));
  КонецЕсли;
  // СтандартныеПодсистемы.ОценкаПроизводительности
  
  ОбновитьЗначенияПараметровДоставки();
  
  Если РежимОстаткиИРезервы Тогда
    ПроверитьПоложениеСклада();
  КонецЕсли;
  
  Если Не ЗначениеЗаполнено(Элементы.КонтактЛицо.ТекстРедактирования) Тогда
    Объект.КонтактЛицо = ПредопределенноеЗначение("Справочник.КонтактныеЛица.ПустаяСсылка");
  КонецЕсли;      
  
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
  
  // СтандартныеПодсистемы.Свойства
  УправлениеСвойствами.ПередЗаписьюНаСервере(ЭтотОбъект, ТекущийОбъект);
  // Конец СтандартныеПодсистемы.Свойства
  
  Если ПараметрыЗаписи.РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
    
    ТекстСообщения = "";
    Справочники.ДоговорыКонтрагентов.ПроверитьСоответствиеДоговораУсловиямДокумента(
    ТекстСообщения, 
    ТекущийОбъект.Договор, 
    ТекущийОбъект.Ссылка, 
    ТекущийОбъект.Организация, 
    ТекущийОбъект.Контрагент, 
    Отказ,         
    ТекущийОбъект.ВидОперации);
    
    Если ТекстСообщения <> "" Тогда
      
      Сообщение = Новый СообщениеПользователю;
      Сообщение.Текст = ?(Отказ, НСтр("ru = 'Документ не проведен! '") + ТекстСообщения, ТекстСообщения);
      
      Если Отказ Тогда
        Сообщение.ПутьКДанным = "Объект";
        Сообщение.Поле = "Договор";
        Сообщение.Сообщить();
        Возврат;
      Иначе
        Сообщение.Сообщить();
      КонецЕсли;
    КонецЕсли;
    
  КонецЕсли;
  
  ТекущийОбъект.ДополнительныеСвойства.Вставить("ТаблицаДокументовДляИзменения", ТаблицаДокументовДляИзменения);
  
  // Обсуждения
  ТекущийОбъект.ДополнительныеСвойства.Вставить("Модифицированность",Модифицированность);
  // Конец Обсуждения     
  
  Если Не ЗначениеЗаполнено(ТекущийОбъект.КонтактЛицо.Наименование) Тогда
    Сообщение = Новый СообщениеПользователю;
    Сообщение.Текст = "Контакт не был заполнен";
    Сообщение.Поле = "КонтактЛицо"; 
    Сообщение.УстановитьДанные(ТекущийОбъект);
    Сообщение.Сообщить();
  КонецЕсли;         
  
КонецПроцедуры


&НаКлиенте
Процедура ПриОткрытии(Отказ)
  
  Если ЗначениеЗаполнено(СписокАвтоПодбораКонтрагента) Тогда
    ПодключитьОбработчикОжидания("ПоказатьВыборИзКлассификатораКонтактов", 0.1, Истина);
  КонецЕсли;
  
  // ГрупповоеИзменениеСтрок
  ОпределитьОбъектИзменений("Запасы");
  ОпределитьОбъектИзменений("МатериалыЗаказчика");
  // Конец ГрупповоеИзменениеСтрок
  
  // ПодключаемоеОборудование
  МенеджерОборудованияКлиент.НачатьПодключениеОборудованиеПриОткрытииФормы(Неопределено, ЭтотОбъект, "СканерШтрихкода");
  // Конец ПодключаемоеОборудование
  
  // СтандартныеПодсистемы.Свойства
  УправлениеСвойствамиКлиент.ПослеЗагрузкиДополнительныхРеквизитов(ЭтотОбъект);
  // Конец СтандартныеПодсистемы.Свойства
  
  // ЭДО
  ОбменСКонтрагентамиКлиент.ПриОткрытии(ЭтотОбъект);
  // Конец ЭДО
  
  // Доставка
  Если Объект.ВидимостьИндикатораТребуетсяРасчет Тогда
    ВключитьИндикаторНеобходимостиПересчетаСтоимостиДоставки();
  Иначе
    ОтключитьИндикаторНеобходимостиПересчетаСтоимостиДоставки(ЭтотОбъект);
  КонецЕсли;
  // Конец Доставка
  
  // СтандартныеПодсистемы.ПодключаемыеКоманды
  ПодключаемыеКомандыКлиент.НачатьОбновлениеКоманд(ЭтотОбъект);
  // Конец СтандартныеПодсистемы.ПодключаемыеКоманды
  
  ОбновитьОтображениеКолонокВРазрезеЗапасов(); 
  
  Если Не ЗначениеЗаполнено(Объект.КонтактЛицо) Тогда
    Объект.КонтактЛицо = КонтактноеЛицо(Объект.Контрагент);
  КонецЕсли;

КонецПроцедуры


&НаСервере
Функция ПолучитьКонтактныеЛицаКонтрагента(КонтрагентНаименование)
  Запрос = Новый Запрос();
  ТекстЗапроса = 
  "ВЫБРАТЬ
  | СвязиКонтрагентКонтактСрезПоследних.Контакт.Ссылка КАК Ссылка,
  | СвязиКонтрагентКонтактСрезПоследних.Контрагент.Наименование КАК КонтрагентНаименование
  |ИЗ
  | РегистрСведений.СвязиКонтрагентКонтакт.СрезПоследних КАК СвязиКонтрагентКонтактСрезПоследних
  |ГДЕ
  | СвязиКонтрагентКонтактСрезПоследних.СвязьНедействительна = ЛОЖЬ
  | И СвязиКонтрагентКонтактСрезПоследних.Контрагент.Наименование = &КонтрагентНаименование
  | И СвязиКонтрагентКонтактСрезПоследних.Период <= &Дата";

  Запрос.Текст = ТекстЗапроса;  
  Запрос.УстановитьПараметр("КонтрагентНаименование", КонтрагентНаименование);
  Запрос.УстановитьПараметр("Дата", ДатаДокумента);
  
  Результат = Запрос.Выполнить();
  Выборка = Результат.Выгрузить().ВыгрузитьКолонку("Ссылка"); 

  Возврат Выборка;
  
КонецФункции

&НаКлиенте
Процедура КонтактЛицоНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)   
  
  СтандартнаяОбработка = Ложь;  
  
  КонтактныеЛица = ПолучитьКонтактныеЛицаКонтрагента(Элементы.Контрагент.ТекстРедактирования); 

  ПараметрыФормы = Новый Структура;
  
  Отборы = Новый Структура("Ссылка", КонтактныеЛица); 
  
  ПараметрыФормы.Вставить("Отбор", Отборы);
  ПараметрыФормы.Вставить("РежимВыбора", Истина);
  
  ОткрытьФорму("Справочник.КонтактныеЛица.ФормаСписка", ПараметрыФормы, Элемент, , , , , РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
  
КонецПроцедуры    
```
